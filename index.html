<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp</title>
  </head>
  <body class="m-0 font-sans bg-white flex justify-center items-center h-screen">
    
<div id="auth-section" class="flex items-center justify-center w-full h-screen bg-[#f4f1e8] fixed top-0 left-0 z-50">
  <div id="auth-content"></div>
</div>
<div class="flex h-[95vh] w-[95vw] shadow-[0_0_20px_rgba(0,0,0,0.15)] rounded-[10px] overflow-hidden">
      
      <div class="w-[70px] bg-[#f4f1e8] flex flex-col items-center justify-center p-[10px]">
        <ul class="list-none p-0 m-0 w-full flex flex-col items-center">
          <li class="my-[15px] w-full flex justify-center">
            <button id="buttonmessage" class="w-[60px] border border-orange-200 bg-none rounded-[10%] p-[5px] hover:bg-orange-300 cursor-pointer text-center text-[14px] flex flex-col items-center">
              <i class="fa-solid fa-message text-black"></i>
              <span class="block text-[12px] mt-[5px]">Messages</span>
            </button>
          </li>
          <li class="my-[15px] w-full flex justify-center">
            <button id="buttongroupe" class="w-[60px] border border-orange-200 bg-none rounded-[10%] p-[5px] hover:bg-orange-300 cursor-pointer text-center text-[14px] flex flex-col items-center">
              <i class="fa-solid fa-user-group text-black"></i>
              <span class="block text-[12px] mt-[5px]">Groupes</span>
            </button>
          </li>
          <li class="my-[15px] w-full flex justify-center">
            <button id="buttondiffusion" class="w-[60px] border border-orange-200 bg-none rounded-[10%] p-[5px] hover:bg-orange-300 cursor-pointer text-center text-[14px] flex flex-col items-center">
              <i class="fa-solid fa-arrows-turn-to-dots text-black"></i>
              <span class="block text-[12px] mt-[5px]">Diffusions</span>
            </button>
          </li>
          <li class="my-[15px] w-full flex justify-center">
            <button id="buttonarchive" class="w-[60px] border border-orange-200 bg-none rounded-[10%] p-[5px] hover:bg-orange-300 cursor-pointer text-center text-[14px] flex flex-col items-center">
              <i class="fa-solid fa-box-archive text-black"></i>
              <span class="block text-[12px] mt-[5px]">Archives</span>
            </button>
          </li>
          <li class="my-[15px] w-full flex justify-center">
            <button id="buttonnew" class="w-[60px] border border-orange-200 bg-none rounded-[10%] p-[5px] hover:bg-orange-300 cursor-pointer text-center text-[14px] flex flex-col items-center">
              <i class="fa-solid fa-plus text-black"></i>
              <span class="block text-[12px] mt-[5px]">Nouveau</span>
            </button>
          </li>
        </ul>
      </div>

   <div id="main-section" class="w-[300px] bg-white p-[15px] border-r border-[#e5e5e5]">
  <div class="flex items-center justify-between mb-2">
    <h3 class="ml-2">Discussions</h3>
        <button id="logout-btn" class="bg-red-200 text-white px-3 py-1 rounded-50 hover:bg-red-600 transition">Déconnexion</button>
  </div>
  <input type="text" id="search-input" placeholder="Recherche..." class="w-[95%] p-[8px] rounded-[5px] border border-[#ccc]">
  <div id="contacts-list" class="mt-4 space-y-2"></div>
</div>
<div id="wat" class="flex-grow flex flex-col bg-[#f4f1e8] justify-between relative">
  <div class="flex bg-white justify-between items-center p-[10px]">
    <div class="flex items-center gap-[10px]">
      <div class="w-[40px] h-[40px] rounded-full overflow-hidden flex justify-center items-center bg-[#585555] p-0">
      </div>
      <div class="text-[16px] font-semibold text-gray-400"></div>
    </div>
    <div class="flex gap-[10px] items-center">
      <button class="border border-orange-500 text-orange-500 w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Vider les messages" disabled>
        <i class="fa-solid fa-delete-left" style="color: #ed7402;"></i>
      </button>
      <button class="border border-[#5e5a5e] w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Archiver les contacts" disabled>
        <i class="fa-solid fa-box-archive" style="color: #5e5a5e;"></i>
      </button>
      <button class="border border-[#2e230e] text-[#1b1603] w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Bloquer le contact" disabled>
        <i class="fa-solid fa-stop" style="color: #1b1603;"></i>
      </button>
      <button class="border border-red-500 text-red-500 w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Supprimer les contacts" disabled>
        <i class="fa-solid fa-trash" style="color: #b43c2f;"></i>
      </button>
    </div>
  </div>
  <div class="flex-grow flex items-center justify-center p-[20px]">
    <span class="text-gray-400 text-[15px]"></span>
  </div>
  <div class="p-0 m-0">
    <div class="flex items-center border border-[#ccc] py-[5px] px-[10px] bg-white w-full box-border">
      <input type="text" class="flex-grow border-none outline-none text-[14px] p-[10px] rounded-[25px] bg-[rgba(241,236,236,0.8)]" placeholder="Écrivez un message..." disabled>
      <button class="bg-[#25D366] border-none text-white text-[20px] w-[40px] h-[40px] rounded-full cursor-pointer flex items-center justify-center ml-[10px]" title="Envoyer" disabled>
        <i class='bx bx-send text-white text-[18px]'></i>
      </button>
    </div>
  </div>
</div>

    <script>
function getUsers() {
  return JSON.parse(localStorage.getItem('users') || '[]');
}
function saveUsers(users) {
  localStorage.setItem('users', JSON.stringify(users));
}
function setCurrentUser(user) {
  localStorage.setItem('currentUser', JSON.stringify(user));
}
function getCurrentUser() {
  return JSON.parse(localStorage.getItem('currentUser') || 'null');
}
function logoutUser() {
  localStorage.removeItem('currentUser');
}

function showLoginForm() {
  document.getElementById('auth-section').style.display = 'flex';
  document.getElementById('auth-content').innerHTML = `
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6 text-green-600">Connexion WhatsApp</h2>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="login-telephone" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Mot de passe</label>
          <input type="password" id="login-password" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">Se connecter</button>
      </form>
      <p class="text-sm text-center text-gray-500 mt-4">
        <a href="#" id="forgot-password-link" class="text-green-600 hover:underline">Mot de passe oublié ?</a>
      </p>
      <p class="text-sm text-center text-gray-500 mt-4">Pas encore inscrit ? <a href="#" id="show-register" class="text-green-600 hover:underline">Créer un compte</a></p>
    </div>
  `;
  document.getElementById('show-register').onclick = showRegisterForm;
  document.getElementById('forgot-password-link').onclick = showForgotPasswordForm;
  document.getElementById('loginForm').onsubmit = function(e) {
    e.preventDefault();
    const tel = document.getElementById('login-telephone').value.trim();
    const pass = document.getElementById('login-password').value;
    const users = getUsers();
    const user = users.find(u => u.telephone === tel && u.password === pass);
    if (user) {
      setCurrentUser(user);
      document.getElementById('auth-section').style.display = 'none';
      location.reload();
    } else {
      showFormMessage('loginForm', "Téléphone ou mot de passe incorrect !", "error");
    }
  };
}
function showForgotPasswordForm() {
  document.getElementById('auth-section').style.display = 'flex';
  document.getElementById('auth-content').innerHTML = `
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6 text-green-600">Réinitialiser le mot de passe</h2>
      <form id="forgotPasswordForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="forgot-telephone" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Nouveau mot de passe</label>
          <input type="password" id="new-password" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">Réinitialiser</button>
      </form>
      <p class="text-sm text-center text-gray-500 mt-4">
        <a href="#" id="show-login" class="text-green-600 hover:underline">Retour à la connexion</a>
      </p>
    </div>
  `;
  document.getElementById('show-login').onclick = showLoginForm;
  document.getElementById('forgotPasswordForm').onsubmit = function(e) {
    e.preventDefault();
    const tel = document.getElementById('forgot-telephone').value.trim();
    const newPassword = document.getElementById('new-password').value;
    const users = getUsers();
    const user = users.find(u => u.telephone === tel);
    if (user) {
      user.password = newPassword; 

      saveUsers(users); 
      showFormMessage('forgotPasswordForm', "Mot de passe réinitialisé avec succès !", "success");
      setTimeout(showLoginForm, 1500);
    } else {
      showFormMessage('forgotPasswordForm', "Numéro de téléphone introuvable.", "error");
    }
  };
}
function showRegisterForm() {
  document.getElementById('auth-section').style.display = 'flex';
  document.getElementById('auth-content').innerHTML = `
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6 text-green-600">Créer un compte</h2>
      <form id="registerForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="register-nom" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="register-telephone" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Mot de passe</label>
          <input type="password" id="register-password" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
        </div>
        <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">S'inscrire</button>
      </form>
      <p class="text-sm text-center text-gray-500 mt-4">Déjà inscrit ? <a href="#" id="show-login" class="text-green-600 hover:underline">Se connecter</a></p>
    </div>
  `;
  document.getElementById('show-login').onclick = showLoginForm;
  document.getElementById('registerForm').onsubmit = function(e) {
    e.preventDefault();
    const nom = document.getElementById('register-nom').value.trim();
    const tel = document.getElementById('register-telephone').value.trim();
    const pass = document.getElementById('register-password').value;
    const users = getUsers();
    if (users.find(u => u.telephone === tel)) {
      showFormMessage('registerForm', "Ce numéro existe déjà !", "error");
      return;
    }
    const user = { nom, telephone: tel, password: pass };
    users.push(user);
    saveUsers(users);
    showFormMessage('registerForm', "Inscription réussie ! Connectez-vous.", "success");
    setTimeout(showLoginForm, 1200);
  };
}
function verifierAuthentification() {
  const utilisateurActuel = getCurrentUser();
  if (!utilisateurActuel) {
    // Afficher le formulaire d'inscription ou de connexion
    document.getElementById('auth-section').style.display = 'flex';
    showRegisterForm(); // Affiche le formulaire d'inscription par défaut
    document.querySelector('.flex.h-[95vh].w-[95vw]').style.display = 'none'; // Masque la page d'accueil
  } else {
    // L'utilisateur est authentifié, afficher la page d'accueil
    document.getElementById('auth-section').style.display = 'none';
    document.querySelector('.flex.h-[95vh].w-[95vw]').style.display = '';
  }
}
window.addEventListener('DOMContentLoaded', () => {
  verifierAuthentification();
});
setTimeout(() => {
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.onclick = () => {
      logoutUser();
      location.reload();
    };
  }
}, 200);
     let contacts = [
  { nom: "Vous", prenom: "", telephone: "775312571" },
  { nom: "Daisa", prenom: "", telephone: "76 621 00 94" },
  { nom: "Louise", prenom: "", telephone: "77 634 54 77" },
  { nom: "Monteiro", prenom: "", telephone: "77 687 21 72" }
];
const brouillons = {}; 
let groupes = [
  { nom: "ODC", description: "esca", membres: ["Vous", "Daisa"] },
  { nom: "Promo2025", description: "groupe2", membres: ["Vous", "Louise"] }
];
loadGroupesFromStorage();
let groupesArchives = [];
let messagesParDiscussion = {};

function genererInitiales(nom, prenom = "") {
  const nomInitial = nom.charAt(0).toUpperCase();
  const prenomInitial = prenom ? prenom.charAt(0).toUpperCase() : "";
  return nomInitial + prenomInitial;
}

function creerAvatar(initiales, couleur = "#4CAF50") {
  return `data:image/svg+xml,${encodeURIComponent(`
    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
      <circle cx="20" cy="20" r="20" fill="${couleur}"/>
      <text x="20" y="28" text-anchor="middle" fill="white" font-family="Arial" font-size="14" font-weight="bold">${initiales}</text>
    </svg>
  `)}`;
}

function verifierNomExistant(nom, prenom = "") {
  const nomComplet = prenom ? `${nom} ${prenom}` : nom;
  const existants = contacts.filter(c => {
    const nomExistant = c.prenom ? `${c.nom} ${c.prenom}` : c.nom;
    return nomExistant.toLowerCase().startsWith(nomComplet.toLowerCase());
  });

  if (existants.length === 0) return nomComplet;
  
  let compteur = 2;
  while (true) {
    const nouveauNom = `${nomComplet} ${compteur}`;
    const trouve = contacts.find(c => {
      const nomExistant = c.prenom ? `${c.nom} ${c.prenom}` : c.nom;
      return nomExistant.toLowerCase() === nouveauNom.toLowerCase();
    });
    if (!trouve) return nouveauNom;
    compteur++;
  }
}
function showFormMessage(formId, message, type = "error") {
  let form = document.getElementById(formId);
  if (!form) return;
  let msgDiv = form.querySelector('.form-message');
  if (!msgDiv) {
    msgDiv = document.createElement('div');
    msgDiv.className = 'form-message mt-2 text-sm';
    form.prepend(msgDiv);
  }
  msgDiv.textContent = message;
  msgDiv.style.color = type === "error" ? "#b91c1c" : "#15803d";
  msgDiv.style.background = type === "error" ? "#fee2e2" : "#dcfce7";
  msgDiv.style.borderRadius = "6px";
  msgDiv.style.padding = "6px 10px";
  msgDiv.style.marginBottom = "8px";
  setTimeout(() => { msgDiv.textContent = ""; }, 3500);
}
function afficherDiffusionContacts() {
  const section = document.createElement('div');
  section.className = 'w-[300px] bg-white p-[15px] border-r border-[#e5e5e5]';
  section.id = 'main-section';
  section.innerHTML = `
    <h3>Diffusion</h3>
    <input type="text" id="search-input" placeholder="Recherche..." class="w-[95%] p-[8px] rounded-[5px] border border-[#ccc] mb-2">
    <form id="diffusion-form">
      <div id="contacts-list" class="space-y-2 mb-4"></div>
    </form>
  `;

  mainSection.replaceWith(section);
  mainSection = section;

  function renderContactsDiffusion(filtre = "") {
    const contactsList = section.querySelector('#contacts-list');
    contactsList.innerHTML = '';
    const contactsFiltres = contacts.filter(contact => {
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      return nomComplet.toLowerCase().includes(filtre.toLowerCase()) ||
             contact.telephone.includes(filtre);
    });
    contactsFiltres.forEach((contact, idx) => {
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      const initiales = genererInitiales(contact.nom, contact.prenom);
      const avatar = creerAvatar(initiales);
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between py-2 border-b-2 border-orange-700';
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
          <span class="font-medium text-sm">${nomComplet}</span>
        </div>
        <input type="checkbox" class="accent-orange-600" data-nom="${nomComplet}" id="diffusion-cb-${idx}">
      `;
      div.addEventListener('click', function(e) {
        if (e.target.tagName !== "INPUT") {
          const cb = div.querySelector('input[type="checkbox"]');
          cb.checked = !cb.checked;
        }
      });
      contactsList.appendChild(div);
    });
  }
  renderContactsDiffusion();

  section.querySelector('#search-input').addEventListener('input', function(e) {
    renderContactsDiffusion(e.target.value.trim());
  });

  const chatArea = document.getElementById('wat');
  if (chatArea) {
    const input = chatArea.querySelector('input[type="text"]');
    const sendBtn = chatArea.querySelector('button[title="Envoyer"]');
    if (input) input.setAttribute('disabled', 'disabled');
    if (sendBtn) sendBtn.setAttribute('disabled', 'disabled');
  }
  function afficherDiffusionContacts() {
  const section = document.createElement('div');
  section.className = 'w-[300px] bg-white p-[15px] border-r border-[#e5e5e5]';
  section.id = 'main-section';
  section.innerHTML = `
    <h3>Diffusion</h3>
    <input type="text" id="search-input" placeholder="Recherche..." class="w-[95%] p-[8px] rounded-[5px] border border-[#ccc] mb-2">
    <form id="diffusion-form">
      <div id="contacts-list" class="space-y-2 mb-4"></div>
    </form>
    <div class="text-xs text-gray-500 mt-2">Sélectionnez un ou plusieurs contacts pour préparer une diffusion.<br>L'envoi du message se fait dans la section 3 (chat) après avoir cliqué sur un contact.</div>
  `;

  mainSection.replaceWith(section);
  mainSection = section;

  function renderContactsDiffusion(filtre = "") {
    const contactsList = section.querySelector('#contacts-list');
    contactsList.innerHTML = '';
    const contactsFiltres = contacts.filter(contact => {
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      return nomComplet.toLowerCase().includes(filtre.toLowerCase()) ||
             contact.telephone.includes(filtre);
    });
    contactsFiltres.forEach((contact, idx) => {
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      const initiales = genererInitiales(contact.nom, contact.prenom);
      const avatar = creerAvatar(initiales);
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between py-2 border-b-2 border-orange-700';
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
          <span class="font-medium text-sm">${nomComplet}</span>
        </div>
        <input type="checkbox" class="accent-orange-600" data-nom="${nomComplet}" id="diffusion-cb-${idx}">
      `;
      div.addEventListener('click', function(e) {
        if (e.target.tagName !== "INPUT") {
          const cb = div.querySelector('input[type="checkbox"]');
          cb.checked = !cb.checked;
          updateChatActivation();
        }
      });
      div.querySelector('input[type="checkbox"]').addEventListener('change', updateChatActivation);
      contactsList.appendChild(div);
    });
  }
  renderContactsDiffusion();

  section.querySelector('#search-input').addEventListener('input', function(e) {
    renderContactsDiffusion(e.target.value.trim());
    updateChatActivation();
  });

  function updateChatActivation() {
    const chatArea = document.getElementById('wat');
    if (chatArea) {
      const input = chatArea.querySelector('input[type="text"]');
      const sendBtn = chatArea.querySelector('button[title="Envoyer"]');
      const checked = section.querySelectorAll('input[type="checkbox"]:checked');
      if (input && sendBtn) {
        if (checked.length === 0) {
          input.setAttribute('disabled', 'disabled');
          sendBtn.setAttribute('disabled', 'disabled');
        } else {
          input.removeAttribute('disabled');
          sendBtn.removeAttribute('disabled');
        }
      }
    }
  }

   updateChatActivation();
}
}
function trierContacts() {
  contacts.sort((a, b) => {
    const nomA = a.prenom ? `${a.nom} ${a.prenom}` : a.nom;
    const nomB = b.prenom ? `${b.nom} ${b.prenom}` : b.nom;
    return nomA.toLowerCase().localeCompare(nomB.toLowerCase());
  });
}
function afficherContacts(filtre = "") {
  const contactsList = document.querySelector('#contacts-list');
  if (!contactsList) return;

  contactsList.innerHTML = '';
  trierContacts();

  const contactsFiltres = contacts.filter(contact => {
    const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
    return contact.nom !== "Vous" && 
           (nomComplet.toLowerCase().includes(filtre.toLowerCase()) ||
           contact.telephone.includes(filtre));
  });

  contactsFiltres.forEach(contact => {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';

    const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
    const initiales = genererInitiales(contact.nom, contact.prenom);
    const avatar = creerAvatar(initiales);

    div.innerHTML = `
      <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
      <div>
        <div class="font-medium text-sm">${nomComplet}</div>
        <div class="text-xs text-gray-500 flex items-center justify-between min-w-[120px]">
          <span>${contact.telephone}</span>
        </div>
      </div>
    `;
    div.addEventListener('click', function() {
      afficherChat(nomComplet, avatar);
    });
    contactsList.appendChild(div);
  });
}

function afficherGroupes(filtre = "") {
  const contactsList = document.querySelector('#contacts-list');
  if (!contactsList) return;
  contactsList.innerHTML = '';
  const groupesFiltres = groupes.filter(groupe => 
    groupe.nom.toLowerCase().includes(filtre.toLowerCase()) ||
    (groupe.description && groupe.description.toLowerCase().includes(filtre.toLowerCase()))
  );
  groupesFiltres.forEach(groupe => {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer group-item';
    const initiales = genererInitiales(groupe.nom);
    const avatar = creerAvatar(initiales, "#e5e5e5");
    div.innerHTML = `
      <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
      <div>
        <div class="font-medium text-sm">${groupe.nom}</div>
        <div class="text-xs text-gray-500">${groupe.description || ''}</div>
      </div>
      <button class="ml-auto px-2 py-1 rounded bg-purple-600 text-white text-xs hover:bg-purple-700" title="Ajouter membre au groupe">
        <i class="fa-solid fa-user-plus"></i>
         </button>
    `;
    div.addEventListener('click', function(e) {
      if (e.target.closest('button')) return;
      afficherChat(groupe.nom, avatar);
    });
    const btnAdd = div.querySelector('button');
    btnAdd.onclick = (e) => {
      e.stopPropagation();
      afficherPopupAjoutMembre(groupe);
    };
    contactsList.appendChild(div);
  });
}
function afficherRecherche(filtre) {
  const contactsList = document.querySelector('#contacts-list');
  if (!contactsList) return;
  
  contactsList.innerHTML = '';

  if (filtre === '*') {
    trierContacts();
    contacts.forEach(contact => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      const initiales = genererInitiales(contact.nom, contact.prenom);
      const avatar = creerAvatar(initiales);
      div.innerHTML = `
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
        <div>
          <div class="font-medium text-sm">${nomComplet}</div>
          <div class="text-xs text-gray-500 flex items-center justify-between min-w-[120px]">
            <span>${contact.telephone}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', function() {
        afficherChat(nomComplet, avatar);
      });
      contactsList.appendChild(div);
    });
    return;
  }
  
  const allContacts = [...contacts, ...archives];
  const contactsFiltres = allContacts.filter(contact => {
    const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
    return nomComplet.toLowerCase().includes(filtre.toLowerCase()) ||
           contact.telephone.includes(filtre);
  });

  const allGroupes = [...groupes, ...groupesArchives];
  const groupesFiltres = allGroupes.filter(groupe => 
    groupe.nom.toLowerCase().includes(filtre.toLowerCase()) ||
    (groupe.description && groupe.description.toLowerCase().includes(filtre.toLowerCase()))
  );

  if (contactsFiltres.length > 0) {
    const contactsHeader = document.createElement('div');
    contactsHeader.className = 'text-xs text-gray-500 mb-2 mt-4 uppercase tracking-wide';
    contactsHeader.textContent = 'Contacts';
    contactsList.appendChild(contactsHeader);

    contactsFiltres.forEach(contact => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      const initiales = genererInitiales(contact.nom, contact.prenom);
      const avatar = creerAvatar(initiales);
      div.innerHTML = `
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
        <div>
          <div class="font-medium text-sm">${nomComplet}</div>
          <div class="text-xs text-gray-500 flex items-center justify-between min-w-[120px]">
            <span>${contact.telephone}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', function() {
        afficherChat(nomComplet, avatar);
      });
      contactsList.appendChild(div);
    });
  }

  if (groupesFiltres.length > 0) {
    const groupesHeader = document.createElement('div');
    groupesHeader.className = 'text-xs text-gray-500 mb-2 mt-4 uppercase tracking-wide';
    groupesHeader.textContent = 'Groupes';
    contactsList.appendChild(groupesHeader);

    groupesFiltres.forEach(groupe => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';
      const initiales = genererInitiales(groupe.nom);
      const avatar = creerAvatar(initiales, "#e5e5e5");
      div.innerHTML = `
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
        <div>
          <div class="font-medium text-sm">${groupe.nom}</div>
          <div class="text-xs text-gray-500">${groupe.description || ''}</div>
        </div>
      `;
      div.addEventListener('click', function() {
        afficherChat(groupe.nom, avatar);
      });
      contactsList.appendChild(div);
    });
  }

  if (contactsFiltres.length === 0 && groupesFiltres.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'text-gray-400 text-sm mt-4';
    emptyDiv.textContent = 'Aucun résultat trouvé.';
    contactsList.appendChild(emptyDiv);
  }
}

function afficherVueInitiale() {
  const section = document.createElement('div');
  section.className = 'w-[300px] bg-white p-[15px] border-r border-[#e5e5e5]';
  section.id = 'main-section';
  section.innerHTML = `
    <h3>Discussions</h3>
    <input type="text" id="search-input" placeholder="Recherche..." class="w-[95%] p-[8px] rounded-[5px] border border-[#ccc]">
    <div id="contacts-list" class="mt-4 space-y-2"></div>
  `;
  return section;
}

function creerInterfaceNouveau() {
  const container = document.createElement('div');
  container.className = 'w-[300px] bg-white p-[15px] border-r border-[#e5e5e5]';
  container.id = 'main-section';

  const headerDiv = document.createElement('div');
  headerDiv.className = 'flex items-center gap-3 mb-4';
  
  const backButton = document.createElement('button');
  backButton.innerHTML = '<i class="fa-solid fa-arrow-left"></i>';
  backButton.className = 'text-gray-600 hover:text-black p-2';
  backButton.onclick = () => restaurerDiscussions();
  
  const title = document.createElement('h3');
  title.textContent = 'Nouvelle discussion';
  title.className = 'text-lg font-medium m-0';
  
  headerDiv.appendChild(backButton);
  headerDiv.appendChild(title);

  const buttonsContainer = document.createElement('div');
  buttonsContainer.className = 'space-y-2 mb-6';

  const newGroupButton = document.createElement('div');
  newGroupButton.className = 'flex items-center gap-3 p-3 hover:bg-gray-100 rounded cursor-pointer';
  newGroupButton.innerHTML = `
    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-users text-white text-sm"></i>
    </div>
    <span class="font-medium">Nouveau groupe</span>
  `;
  newGroupButton.onclick = () => {
    const form = creerFormulaireGroupe();
    mainSection.replaceWith(form);
    mainSection = form;
  };

  const newContactButton = document.createElement('div');
  newContactButton.className = 'flex items-center gap-3 p-3 hover:bg-gray-100 rounded cursor-pointer';
  newContactButton.innerHTML = `
    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-user-plus text-white text-sm"></i>
    </div>
    <span class="font-medium">Nouveau contact</span>
  `;
  newContactButton.onclick = () => {
    const form = creerFormulaireContact();
    mainSection.replaceWith(form);
    mainSection = form;
  };

  buttonsContainer.appendChild(newGroupButton);
  buttonsContainer.appendChild(newContactButton);

  container.appendChild(headerDiv);
  container.appendChild(buttonsContainer);

  return container;
}
function saveGroupesToStorage() {
  localStorage.setItem('groupes', JSON.stringify(groupes));
}
function loadGroupesFromStorage() {
  const data = localStorage.getItem('groupes');
  if (data) groupes = JSON.parse(data);
}
function creerFormulaireContact() {
  const container = document.createElement('div');
  container.className = 'w-[300px] p-[15px] border-r flex flex-col bg-white';
  
  const headerDiv = document.createElement('div');
  headerDiv.className = 'flex items-center gap-3 mb-4';
  
  const backButton = document.createElement('button');
  backButton.innerHTML = '<i class="fa-solid fa-arrow-left"></i>';
  backButton.className = 'text-gray-600 hover:text-black p-2';
  backButton.onclick = () => {
    const nouvelleInterface = creerInterfaceNouveau();
    mainSection.replaceWith(nouvelleInterface);
    mainSection = nouvelleInterface;
  };
  
  const title = document.createElement('h3');
  title.textContent = 'Nouveau contact';
  title.className = 'text-lg font-semibold text-black m-0';
  
  headerDiv.appendChild(backButton);
  headerDiv.appendChild(title);

  const contentDiv = document.createElement('div');
  contentDiv.className = 'flex-grow px-[20px] pt-[25px] pb-[20px] flex flex-col gap-[25px] overflow-y-auto';

  const nomDiv = document.createElement('div');
  nomDiv.className = 'flex items-center gap-[10px] border-b border-gray-300 py-[5px]';
  
  const nomIcon = document.createElement('i');
  nomIcon.className = 'fa-solid fa-user w-[20px] text-center';
  
  const nomInput = document.createElement('input');
  nomInput.type = 'text';
  nomInput.id = 'nom-input';
  nomInput.placeholder = 'Nom';
  nomInput.className = 'flex-grow outline-none text-[14px]';
  
  nomDiv.appendChild(nomIcon);
  nomDiv.appendChild(nomInput);

  const prenomDiv = document.createElement('div');
  prenomDiv.className = 'flex items-center gap-[10px] border-b border-gray-300 py-[5px]';
  
  const prenomIcon = document.createElement('i');
  prenomIcon.className = 'fa-solid fa-user w-[20px] text-center';
  
  const prenomInput = document.createElement('input');
  prenomInput.type = 'text';
  prenomInput.id = 'prenom-input';
  prenomInput.placeholder = 'Prénom (optionnel)';
  prenomInput.className = 'flex-grow outline-none text-[14px]';
  
  prenomDiv.appendChild(prenomIcon);
  prenomDiv.appendChild(prenomInput);

  const telDiv = document.createElement('div');
  telDiv.className = 'flex items-center gap-[10px] border-b border-gray-300 py-[5px]';
  
  const telIcon = document.createElement('i');
  telIcon.className = 'fa-solid fa-phone w-[20px] text-center';
  
  const telInput = document.createElement('input');
  telInput.type = 'text';
  telInput.id = 'telephone-input';
  telInput.placeholder = 'Téléphone';
  telInput.className = 'flex-grow outline-none text-[14px]';
  
  telDiv.appendChild(telIcon);
  telDiv.appendChild(telInput);

  contentDiv.appendChild(nomDiv);
  contentDiv.appendChild(prenomDiv);
  contentDiv.appendChild(telDiv);

  const saveButton = document.createElement('button');
  saveButton.id = 'save-contact';
  saveButton.textContent = 'Enregistrer';
  saveButton.className = 'w-full p-[15px] rounded-[25px] text-[16px] bg-[#d6d1d1] font-semibold hover:bg-[#aca9a9]';

  container.appendChild(headerDiv);
  container.appendChild(contentDiv);
  container.appendChild(saveButton);

  setTimeout(() => {
    document.getElementById('save-contact').onclick = () => {
      const nom = document.getElementById('nom-input').value.trim();
      const prenom = document.getElementById('prenom-input').value.trim();
      const telephone = document.getElementById('telephone-input').value.trim();
      
      if (nom && telephone) {
        const numeroExiste = contacts.find(c => c.telephone === telephone);
       if (numeroExiste) {
  showFormMessage('contact-form', "Ce numéro de téléphone existe déjà !", "error");
  return;
}
      if (!/^\d+$/.test(telephone)) {
  showFormMessage('contact-form', "Le numéro doit être uniquement composé de chiffres !", "error");
  return;
}
        const nomFinal = verifierNomExistant(nom, prenom);
        const [nomModifie, prenomModifie] = nomFinal.includes(' ') && !nomModifie.match(/\d$/) 
          ? nomFinal.split(' ', 2) 
          : nomFinal.includes(' ') 
            ? [nomFinal, ''] 
            : [nomFinal, ''];

        contacts.push({ 
          nom: nomModifie, 
          prenom: prenomModifie, 
          telephone 
        });
        restaurerDiscussions();
   } else {
  showFormMessage('contact-form', "Veuillez remplir au moins le nom et le téléphone", "error");
}
    };
  }, 100);

  return container;
}
function afficherPopupMembresGroupe(nomGroupe) {
  const groupe = groupes.find(g => g.nom === nomGroupe) || groupesArchives.find(g => g.nom === nomGroupe);
  if (!groupe) return;

  if (typeof groupe.membres[0] === "string") {
    groupe.membres = groupe.membres.map(nom => ({ nom, statut: nom === "Vous" ? "admin" : "membre" }));
  }

  let popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '0';
  popup.style.left = '0';
  popup.style.width = '100vw';
  popup.style.height = '100vh';
  popup.style.background = 'rgba(0,0,0,0.2)';
  popup.style.display = 'flex';
  popup.style.alignItems = 'center';
  popup.style.justifyContent = 'center';
  popup.style.zIndex = '9999';

  popup.innerHTML = `
    <div style="background:#fff;padding:24px 32px;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.15);min-width:320px;max-height:80vh;display:flex;flex-direction:column;align-items:center;">
      <div style="font-weight:bold;font-size:17px;margin-bottom:12px;">Membres du groupe</div>
      <div id="popup-membres-list" style="overflow-y:auto;max-height:300px;width:100%;margin-bottom:16px;">
        ${groupe.membres.map((m, i) => {
          const isAdmin = m.statut === "admin";
          const adminBadge = isAdmin ? `<div style="color:#25d366;font-size:12px;margin-top:2px;">(admin)</div>` : "";
          const showBtns = m.nom !== "Vous";
          return `
            <div class="popup-membre-item" data-index="${i}" style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #eee;">
              <div style="flex:1;display:flex;flex-direction:column;">
                <span style="font-size:15px;">${m.nom}</span>
                ${adminBadge}
                <div class="form-message text-xs mt-1" style="color:#b43c2f;"></div>
              </div>
              ${showBtns ? `
                <div style="display:flex;gap:6px; margin-left:auto;">
                  <button class="btn-statut" style="padding:2px 6px;border-radius:6px;background:#eee;border:none;cursor:pointer;font-size:11px;">
                    ${isAdmin ? "Rendre membre" : "Rendre admin"}
                  </button>
                  <button class="btn-retirer" style="padding:2px 6px;border-radius:6px;background:#ffdddd;border:none;cursor:pointer;font-size:11px;color:#b43c2f;">
                    Retirer
                  </button>
                </div>
              ` : ""}
            </div>
          `;
        }).join('')}
      </div>
      <button id="fermer-popup-btn" style="margin-top:8px;padding:6px 18px;border-radius:8px;background:#eee;border:none;cursor:pointer;">Fermer</button>
    </div>
  `;
  document.body.appendChild(popup);

  popup.querySelectorAll('.btn-statut').forEach((btn, idx) => {
    btn.onclick = () => {
      const membre = groupe.membres[idx];
      if (membre.nom === "Vous") return;
      membre.statut = membre.statut === "admin" ? "membre" : "admin";
      saveGroupesToStorage();
      popup.remove();
      afficherPopupMembresGroupe(nomGroupe);
    };
  });
  popup.querySelectorAll('.btn-retirer').forEach((btn, idx) => {
    btn.onclick = () => {
      const membre = groupe.membres[idx];
      if (membre.nom === "Vous") {
        let msgDiv = btn.closest('.popup-membre-item').querySelector('.form-message');
        if (!msgDiv) {
          msgDiv = document.createElement('div');
          msgDiv.className = 'form-message text-xs mt-1';
          btn.closest('.popup-membre-item').appendChild(msgDiv);
        }
        msgDiv.textContent = "Vous ne pouvez pas vous retirer vous-même du groupe.";
        setTimeout(() => { msgDiv.textContent = ""; }, 2500);
        return;
      }
      groupe.membres.splice(idx, 1);
      saveGroupesToStorage();
      popup.remove();
      afficherPopupMembresGroupe(nomGroupe);
    };
  });

  popup.querySelector('#fermer-popup-btn').onclick = () => popup.remove();
  popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
}
function creerFormulaireGroupe() {
 const container = document.createElement('div');
container.className = 'w-[300px] p-[15px] border-r flex flex-col bg-white';
container.id = 'contact-form'; 
  const headerDiv = document.createElement('div');
  headerDiv.className = 'flex items-center gap-3 mb-4';
  
  const backButton = document.createElement('button');
  backButton.innerHTML = '<i class="fa-solid fa-arrow-left"></i>';
  backButton.className = 'text-gray-600 hover:text-black p-2';
  backButton.onclick = () => {
    const nouvelleInterface = creerInterfaceNouveau();
    mainSection.replaceWith(nouvelleInterface);
    mainSection = nouvelleInterface;
  };
  
  const title = document.createElement('h3');
  title.textContent = 'Nouveau groupe';
  title.className = 'text-lg font-semibold text-black m-0';
  
  headerDiv.appendChild(backButton);
  headerDiv.appendChild(title);

  const contentDiv = document.createElement('div');
  contentDiv.className = 'flex-grow px-[20px] pt-[25px] pb-[20px] flex flex-col gap-[25px] overflow-y-auto';

  const nomDiv = document.createElement('div');
  nomDiv.className = 'flex items-center gap-[10px] border-b border-gray-300 py-[5px]';
  
  const nomIcon = document.createElement('i');
  nomIcon.className = 'fa-solid fa-users w-[20px] text-center';
  
  const nomInput = document.createElement('input');
  nomInput.type = 'text';
  nomInput.id = 'groupe-nom-input';
  nomInput.placeholder = 'Nom du groupe';
  nomInput.className = 'flex-grow outline-none text-[14px]';
  
  nomDiv.appendChild(nomIcon);
  nomDiv.appendChild(nomInput);

  const descDiv = document.createElement('div');
  descDiv.className = 'flex items-start gap-[10px] border-b border-gray-300 py-[5px]';
  
  const descIcon = document.createElement('i');
  descIcon.className = 'fa-solid fa-info w-[20px] text-center mt-1';
  
  const descTextarea = document.createElement('textarea');
  descTextarea.id = 'groupe-description-input';
  descTextarea.placeholder = 'Description du groupe (optionnel)';
  descTextarea.className = 'flex-grow outline-none text-[14px] resize-none';
  descTextarea.rows = 3;
  
  descDiv.appendChild(descIcon);
  descDiv.appendChild(descTextarea);

  const membresDiv = document.createElement('div');
  membresDiv.className = 'flex flex-col gap-2';
  membresDiv.innerHTML = `<div class="text-sm text-gray-500 mb-1">Sélectionnez les membres (au moins 2)</div>`;

  const vousCheckboxDiv = document.createElement('div');
  vousCheckboxDiv.className = 'flex items-center gap-2';
  vousCheckboxDiv.innerHTML = `
    <input type="checkbox" checked disabled id="membre-vous" class="accent-green-500">
    <label for="membre-vous" class="text-sm">Vous (admin)</label>
  `;
  membresDiv.appendChild(vousCheckboxDiv);

 contacts.filter(c => c.nom !== "Vous").forEach((contact, idx) => {
  const id = `membre-${idx}`;
  const div = document.createElement('div');
  div.className = 'flex items-center gap-2';
  div.innerHTML = `
    <input type="checkbox" id="${id}" class="accent-green-500" value="${contact.nom}">
    <label for="${id}" class="text-sm">${contact.nom}${contact.prenom ? ' ' + contact.prenom : ''} (${contact.telephone})</label>
  `;
  membresDiv.appendChild(div);
});

  contentDiv.appendChild(nomDiv);
  contentDiv.appendChild(descDiv);
  contentDiv.appendChild(membresDiv);

  const saveButton = document.createElement('button');
  saveButton.id = 'save-groupe';
  saveButton.textContent = 'Créer le groupe';
  saveButton.className = 'w-full p-[15px] rounded-[25px] text-[16px] bg-[#d6d1d1] font-semibold hover:bg-[#aca9a9]';

  container.appendChild(headerDiv);
  container.appendChild(contentDiv);
  container.appendChild(saveButton);

setTimeout(() => {
  document.getElementById('save-groupe').onclick = () => {
    const nom = document.getElementById('groupe-nom-input').value.trim();
    const description = document.getElementById('groupe-description-input').value.trim();
    const membres = ["Vous"]; 
    membresDiv.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(cb => {
      if (cb.checked) membres.push(cb.value);
    });

    if (!nom) {
      showFormMessage('contact-form', "Veuillez entrer un nom pour le groupe", "error");
      return;
    }
    if (membres.length < 2) {
      showFormMessage('contact-form', "Veuillez sélectionner au moins deux membres (vous inclus) !", "error");
      return;
    }

    groupes.push({ 
      nom, 
      description: description || 'Aucune description',
      membres
    });
    restaurerDiscussions();
  };
}, 100);

  return container;
}

function restaurerDiscussions() {
  const section = afficherVueInitiale();
  mainSection.replaceWith(section);
  mainSection = document.getElementById('main-section');

  setTimeout(() => {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      const newInput = searchInput.cloneNode(true);
      searchInput.parentNode.replaceChild(newInput, searchInput);

      newInput.addEventListener('input', (e) => {
        const filtre = e.target.value.trim();
        if (filtre) {
          afficherRecherche(filtre);
        } else {
          afficherDiscussions();
        }
      });
    }
  }, 50);
}
function afficherRecherche(filtre) {
  const contactsList = document.querySelector('#contacts-list');
  if (!contactsList) return;
  contactsList.innerHTML = '';

  if (filtre === '*') {
    trierContacts();
    contacts.forEach(contact => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      const initiales = genererInitiales(contact.nom, contact.prenom);
      const avatar = creerAvatar(initiales);
      div.innerHTML = `
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
        <div>
          <div class="font-medium text-sm">${nomComplet}</div>
          <div class="text-xs text-gray-500 flex items-center justify-between min-w-[120px]">
            <span>${contact.telephone}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', function() {
        afficherChat(nomComplet, avatar);
      });
      contactsList.appendChild(div);
    });
    return;
  }

  const allContacts = [...contacts, ...archives];
  const contactsFiltres = allContacts.filter(contact => {
    const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
    return nomComplet.toLowerCase().includes(filtre.toLowerCase()) ||
           contact.telephone.includes(filtre);
  });

  const allGroupes = [...groupes, ...groupesArchives];
  const groupesFiltres = allGroupes.filter(groupe => 
    groupe.nom.toLowerCase().includes(filtre.toLowerCase()) ||
    (groupe.description && groupe.description.toLowerCase().includes(filtre.toLowerCase()))
  );

  if (contactsFiltres.length > 0) {
    const contactsHeader = document.createElement('div');
    contactsHeader.className = 'text-xs text-gray-500 mb-2 mt-4 uppercase tracking-wide';
    contactsHeader.textContent = 'Contacts';
    contactsList.appendChild(contactsHeader);

    contactsFiltres.forEach(contact => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';
      const nomComplet = contact.prenom ? `${contact.nom} ${contact.prenom}` : contact.nom;
      const initiales = genererInitiales(contact.nom, contact.prenom);
      const avatar = creerAvatar(initiales);
      div.innerHTML = `
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
        <div>
          <div class="font-medium text-sm">${nomComplet}</div>
          <div class="text-xs text-gray-500 flex items-center justify-between min-w-[120px]">
            <span>${contact.telephone}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', function() {
        afficherChat(nomComplet, avatar);
      });
      contactsList.appendChild(div);
    });
  }

  if (groupesFiltres.length > 0) {
    const groupesHeader = document.createElement('div');
    groupesHeader.className = 'text-xs text-gray-500 mb-2 mt-4 uppercase tracking-wide';
    groupesHeader.textContent = 'Groupes';
    contactsList.appendChild(groupesHeader);

    groupesFiltres.forEach(groupe => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer';
      const initiales = genererInitiales(groupe.nom);
      const avatar = creerAvatar(initiales, "#e5e5e5");
      div.innerHTML = `
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover">
        <div>
          <div class="font-medium text-sm">${groupe.nom}</div>
          <div class="text-xs text-gray-500">${groupe.description || ''}</div>
        </div>
      `;
      div.addEventListener('click', function() {
        afficherChat(groupe.nom, avatar);
      });
      contactsList.appendChild(div);
    });
  }

  if (contactsFiltres.length === 0 && groupesFiltres.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'text-gray-400 text-sm mt-4';
    emptyDiv.textContent = 'Aucun résultat trouvé.';
    contactsList.appendChild(emptyDiv);
  }
}
const btnnew = document.querySelector("#buttonnew");
const btnmessage = document.querySelector("#buttonmessage");
const btngroupe = document.querySelector("#buttongroupe");
const btndiffusion = document.querySelector("#buttondiffusion");
const btnarchive = document.querySelector("#buttonarchive");
let mainSection = document.querySelector("#main-section");
let currentMode = 'contacts';

function initSearchInput() {
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const filtre = e.target.value.trim();
      if (filtre.length >= 2) {
        afficherRecherche(filtre);
      } else if (filtre.length === 0) {
        afficherContacts();
        afficherGroupes();
      } else {
        afficherContacts();
        afficherGroupes();
      }
    });

    searchInput.addEventListener('focus', (e) => {
      if (e.target.value.trim().length === 0) {
        afficherContacts();
        afficherGroupes();
      }
    });
  }
}

btnnew.onclick = () => {
  const nouvelleInterface = creerInterfaceNouveau();
  mainSection.replaceWith(nouvelleInterface);
  mainSection = nouvelleInterface;
};
btnmessage.onclick = () => {
  const titleElement = document.querySelector('#main-section h3');
  if (titleElement) {
    titleElement.textContent = 'Messages'; // Change le titre en "Messages"
  }
  restaurerDiscussions();
  setTimeout(() => afficherDiscussions(), 50);
};
btngroupe.onclick = () => {
  const titleElement = document.querySelector('#main-section h3');
  if (titleElement) {
    titleElement.textContent = 'Groupes'; // Change le titre en "Groupes"
  }
  restaurerDiscussions();
  setTimeout(() => afficherGroupes(), 50);
};
btndiffusion.onclick = () => {
  const titleElement = document.querySelector('#main-section h3');
  if (titleElement) {
    titleElement.textContent = 'Diffusions'; // Change le titre en "Diffusions"
  }
  afficherDiffusionContacts();
};
btnarchive.onclick = () => {
  const titleElement = document.querySelector('#main-section h3');
  if (titleElement) {
    titleElement.textContent = 'Archives'; // Change le titre en "Archives"
  }
  if (mainSection.querySelector('h3')?.textContent !== 'Discussions') {
    restaurerDiscussions();
  }
  setTimeout(() => {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.value = '';
      searchInput.placeholder = 'Recherche dans les discussions archivées...';
      searchInput.oninput = (e) => {
        const val = e.target.value.trim().toLowerCase();
        afficherArchives(val);
      };
    }
    afficherArchives();
  }, 50);
};



setTimeout(() => {
  if (!document.getElementById('wat')) {
    afficherContacts();
  }
}, 100);

setTimeout(() => {
  if (!document.getElementById('wat')) {
    initSearchInput();
  }
}, 100);
function creerZoneChat(nomContact, avatarUrl = "chemin/vers/profil.jpg") {
  const groupe = groupes.find(g => g.nom === nomContact) || groupesArchives.find(g => g.nom === nomContact);
  let membresHtml = '';
  let nomHtml = `<div class="text-[16px] font-semibold">${nomContact}</div>`;
  if (groupe) {
    nomHtml = `<div class="text-[16px] font-semibold cursor-pointer text-green-700 hover:underline" id="groupe-nom-popup">${nomContact}</div>`;
    membresHtml = `
      <div class="text-xs text-gray-600 mt-1">
        Membres : ${Array.isArray(groupe.membres) ? (groupe.membres.map(m => typeof m === "string" ? m : m.nom).join(', ')) : ''}
      </div>
    `;
  }

  const chatArea = document.createElement('div');
  chatArea.className = "flex-grow bg-[#f4f1e8] flex flex-col justify-between relative";

  chatArea.innerHTML = `
    <div class="flex bg-white justify-between items-center p-[10px]">
      <div class="flex items-center gap-[10px]">
        <div class="w-[40px] h-[40px] rounded-full overflow-hidden flex justify-center items-center bg-[#585555] p-0">
          <img src="${avatarUrl}" alt="Profil" class="w-full h-full object-cover rounded-full" />
        </div>
        <div>
          ${nomHtml}
          ${membresHtml}
        </div>
      </div>
      <div class="flex gap-[10px] items-center">
        <button class="border border-orange-500 text-orange-500 w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Vider les messages">
          <i class="fa-solid fa-delete-left" style="color: #ed7402;"></i>
        </button>
        <button class="border border-[#5e5a5e]  w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Archiver les contacts">
          <i class="fa-solid fa-box-archive" style="color: #5e5a5e;"></i>
        </button>
        <button class="border border-[#2e230e] text-[#1b1603] w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Bloquer le contact">
          <i class="fa-solid fa-stop" style="color: #1b1603;"></i>
        </button>
        <button class="border border-red-500 text-red-500 w-[28px] h-[28px] rounded-full flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#f0f0f0] hover:shadow-[0_2px_5px_rgba(0,0,0,0.15)]" title="Supprimer les contacts">
          <i class="fa-solid fa-trash" style="color: #b43c2f;"></i>
        </button>
      </div>
    </div>
    <div class="chat-messages flex-grow p-[20px] overflow-y-auto"></div>
    <div class="p-0 m-0">
      <div class="flex items-center border border-[#ccc] py-[5px] px-[10px] bg-white w-full box-border">
        <input type="text" class="flex-grow border-none outline-none text-[14px] p-[10px] rounded-[25px] bg-[rgba(241,236,236,0.8)]" placeholder="Écrivez un message...">
        <button class="bg-[#25D366] border-none text-white text-[20px] w-[40px] h-[40px] rounded-full cursor-pointer flex items-center justify-center ml-[10px]" title="Envoyer">
          <i class='bx bx-send text-white text-[18px]'></i>
        </button>
      </div>
    </div>
  `;
  return chatArea;
}
function afficherChat(nom, avatarUrl) {
  let chatArea = document.querySelector('.flex-grow.bg-\\[\\#f4f1e8\\]');
  if (chatArea) chatArea.remove();
  const container = document.querySelector('.flex.h-\\[95vh\\].w-\\[95vw\\]');
  if (container) {
    const chatDiv = creerZoneChat(nom, avatarUrl);
    container.appendChild(chatDiv);

    const input = chatDiv.querySelector('input[type="text"]');
    const sendBtn = chatDiv.querySelector('button[title="Envoyer"]');

    if (brouillons[nom]) {
      input.value = brouillons[nom];
      sendBtn.disabled = input.value.trim() === "";
    }

    input.addEventListener('input', () => {
      brouillons[nom] = input.value;
    });

    sendBtn.onclick = () => {
      const message = input.value.trim();
      if (!message) return;

      delete brouillons[nom];

      if (!messagesParDiscussion[nom]) messagesParDiscussion[nom] = [];
      messagesParDiscussion[nom].push({ text: message, type: "sent" });

      const now = new Date();
      const heure = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      let disc = discussions.find(d => d.nom === nom);
      if (disc) {
        disc.lastMessage = message;
        disc.heure = heure;
        disc.lu = true;
      }

      renderMessages();
      input.value = "";
      sendBtn.disabled = true;

      afficherDiscussions();
    };

    function renderMessages() {
      const chatContent = chatDiv.querySelector('.chat-messages');
      chatContent.innerHTML = "";
      const messages = messagesParDiscussion[nom] || [];
      messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = msg.type === "sent" ? "mb-2 flex justify-end" : "mb-2 flex justify-start";
        msgDiv.innerHTML = `
          <span class="inline-block ${msg.type === "sent" ? "bg-[#25D366] text-white" : "bg-white text-gray-800 border"} px-3 py-1 rounded-2xl text-sm max-w-[70%] break-words">
            ${msg.text}
          </span>
        `;
        chatContent.appendChild(msgDiv);
      });
      chatContent.scrollTop = chatContent.scrollHeight;
    }

    renderMessages();
  }
}
function isInArchives(nom) {
  return archives.some(a => (a.prenom ? `${a.nom} ${a.prenom}` : a.nom) === nom);
}
function archiverContact(nom) {
  const idx = contacts.findIndex(c => (c.prenom ? `${c.nom} ${c.prenom}` : c.nom) === nom);
  if (idx !== -1) {
    archives.push(contacts[idx]);
    contacts.splice(idx, 1);
    console.log("Contact archivé :", nom);
  }
}
function desarchiverContact(nom) {
  const idx = archives.findIndex(a => (a.prenom ? `${a.nom} ${a.prenom}` : a.nom) === nom);
  if (idx !== -1) {
    contacts.push(archives[idx]);
    archives.splice(idx, 1);
    console.log("Contact désarchivé :", nom);
  }
}

let archives = [
  { nom: "Ancien Contact", prenom: "", telephone: "77 000 00 00" }
];

function afficherArchives() {
  const contactsList = document.querySelector('#contacts-list');
  if (!contactsList) return;
  contactsList.innerHTML = '';

  const discussionsArchivees = discussions.filter(disc => {
    if (disc.type === "contact") {
      return archives.some(a => (a.prenom ? `${a.nom} ${a.prenom}` : a.nom) === disc.nom);
    } else if (disc.type === "groupe") {
      return groupesArchives.some(g => g.nom === disc.nom);
    }
    return false;
  });

  discussionsArchivees.sort((a, b) => b.heure.localeCompare(a.heure));

  if (discussionsArchivees.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'text-gray-400 text-sm mt-4';
    emptyDiv.textContent = 'Aucune discussion archivée trouvée.';
    contactsList.appendChild(emptyDiv);
    return;
  }

  discussionsArchivees.forEach(disc => {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer relative';

    div.innerHTML = `
      <img src="${disc.avatar}" class="w-10 h-10 rounded-full object-cover">
      <div class="flex-1">
        <div class="flex items-center justify-between">
          <div class="font-medium text-sm">${disc.nom}</div>
          <div class="text-xs text-gray-400 ml-2">${disc.heure}</div>
        </div>
        <div class="text-xs text-gray-500 truncate max-w-[180px]">${disc.lastMessage}</div>
      </div>
      <span class="ml-2 flex-shrink-0 w-2 h-2 rounded-full ${disc.lu ? 'bg-gray-400' : 'bg-green-500'} inline-block absolute right-2 top-1/2 -translate-y-1/2"></span>
    `;

    div.onclick = () => {
      disc.lu = true;
      afficherChat(disc.nom, disc.avatar);
      afficherArchives(); 
    };

    contactsList.appendChild(div);
  });
}
btnarchive.onclick = () => {
  const titleElement = document.querySelector('#main-section h3');
  if (titleElement) {
    titleElement.textContent = 'Archives'; // Change le titre en "Archives"
  }
  if (mainSection.querySelector('h3')?.textContent !== 'Discussions') {
    restaurerDiscussions();
  }
  setTimeout(() => {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.value = '';
      searchInput.placeholder = 'Recherche dans les discussions archivées...';
      searchInput.oninput = (e) => {
        const val = e.target.value.trim().toLowerCase();
        afficherArchives(val);
      };
    }
    afficherArchives();
  }, 50);
};
function initSearchInput() {
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('focus', (e) => {
      if (e.target.value.trim().length === 0) {
        afficherContacts();
        afficherGroupes();
      }
    });

    searchInput.addEventListener('input', (e) => {
      const filtre = e.target.value.trim();
      if (filtre.length >= 2) {
        afficherRecherche(filtre);
      } else {
        afficherContacts();
        afficherGroupes();
      }
    });
  }
}

initSearchInput();

function afficherPopupAjoutMembre(groupe) {
  const popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '0';
  popup.style.left = '0';
  popup.style.width = '100vw';
  popup.style.height = '100vh';
  popup.style.background = 'rgba(0,0,0,0.2)';
  popup.style.display = 'flex';
  popup.style.alignItems = 'center';
  popup.style.justifyContent = 'center';
  popup.style.zIndex = '9999';

  const membresExistants = groupe.membres || [];
  const contactsNonMembres = contacts.filter(c => c.nom !== "Vous" && !membresExistants.includes(c.nom)); // Exclut "Vous"

  let selection = [];

  popup.innerHTML = `
    <div style="background:#fff;padding:24px 32px;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.15);min-width:320px;max-height:80vh;display:flex;flex-direction:column;align-items:center;">
      <div style="font-weight:bold;font-size:17px;margin-bottom:12px;">Ajouter des membres</div>
      <div id="popup-contacts-list" style="overflow-y:auto;max-height:300px;width:100%;margin-bottom:16px;">
        ${contactsNonMembres.map((c, i) => {
          const nomComplet = c.prenom ? `${c.nom} ${c.prenom}` : c.nom;
          return `
            <div class="popup-contact-item" data-index="${i}" style="cursor:pointer;display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #eee;transition:background 0.2s;">
              <img src="${creerAvatar(genererInitiales(c.nom, c.prenom))}" style="width:32px; height:32px;border-radius:50%;">
              <span style="font-size:15px;">${nomComplet}</span>
            </div>
          `;
        }).join('')}
      </div>
      <button id="ajouter-membres-btn" style="margin-top:8px;padding:8px 24px;border-radius:8px;background:#25d366;color:#fff;border:none;font-weight:bold;font-size:15px;cursor:pointer;opacity:0.7;" disabled>Ajouter en tant que membre</button>
      <button id="fermer-popup-btn" style="margin-top:8px;padding:6px 18px;border-radius:8px;background:#eee;border:none;cursor:pointer;">Fermer</button>
    </div>
  `;

  document.body.appendChild(popup);

  const items = popup.querySelectorAll('.popup-contact-item');
  items.forEach(item => {
    item.onclick = () => {
      const idx = parseInt(item.getAttribute('data-index'));
      const contact = contactsNonMembres[idx];
      const nomComplet = contact.nom;
      if (selection.includes(nomComplet)) {
        selection = selection.filter(n => n !== nomComplet);
        item.style.background = '';
      } else {
        selection.push(nomComplet);
        item.style.background = 'rgba(39, 174, 96, 0.15)';
      }
      const btn = popup.querySelector('#ajouter-membres-btn');
      btn.disabled = selection.length === 0;
      btn.style.opacity = selection.length === 0 ? '0.7' : '1';
    };
  });

  popup.querySelector('#ajouter-membres-btn').onclick = () => {
    selection.forEach(nom => {
      if (!groupe.membres.includes(nom)) {
        groupe.membres.push(nom);
      }
    });
    popup.remove();
  };

  popup.querySelector('#fermer-popup-btn').onclick = () => popup.remove();

  popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
}
function isGroupeInArchives(nom) {
  return groupesArchives.some(g => g.nom === nom);
}
function archiverGroupe(nom) {
  const idx = groupes.findIndex(g => g.nom === nom);
  if (idx !== -1) {
    groupesArchives.push(groupes[idx]);
    groupes.splice(idx, 1);
    console.log("Groupe archivé :", nom);
  }
}
function desarchiverGroupe(nom) {
  const idx = groupesArchives.findIndex(g => g.nom === nom);
  if (idx !== -1) {
    groupes.push(groupesArchives[idx]);
    groupesArchives.splice(idx, 1);
    console.log("Groupe désarchivé :", nom);
  }
}
let discussions = [
  {
    type: "contact",
    nom: "Daisa",
    avatar: creerAvatar(genererInitiales("Daisa")),
    lastMessage: "Salut !",
    heure: "10:45",
    lu: false
  },
  {
    type: "groupe",
    nom: "ODC",
    avatar: creerAvatar(genererInitiales("ODC"), "#e5e5e5"),
    lastMessage: "Bienvenue dans le groupe !",
    heure: "09:30",
    lu: true
  }
];
function afficherDiscussions() {
  const contactsList = document.querySelector('#contacts-list');
  if (!contactsList) return;
  contactsList.innerHTML = '';

  const discussionsActives = discussions.filter(disc => {
    if (disc.type === "contact") {
      return !archives.some(a => (a.prenom ? `${a.nom} ${a.prenom}` : a.nom) === disc.nom);
    } else if (disc.type === "groupe") {
      return !groupesArchives.some(g => g.nom === disc.nom);
    }
    return true;
  });

  discussionsActives.sort((a, b) => b.heure.localeCompare(a.heure));

  discussionsActives.forEach(disc => {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer relative';

    const brouillon = brouillons[disc.nom];
    let previewTexte = disc.lastMessage || "";
    if (brouillon) {
      previewTexte = `Brouillon: ${brouillon}`;
    }

    div.innerHTML = `
      <img src="${disc.avatar}" class="w-10 h-10 rounded-full object-cover">
      <div class="flex-1">
        <div class="flex items-center justify-between">
          <div class="font-medium text-sm">${disc.nom}</div>
          <div class="text-xs text-gray-400 ml-2">${disc.heure}</div>
        </div>
        <div class="text-xs text-gray-500 truncate max-w-[180px]">${previewTexte}</div>
      </div>
      <span class="ml-2 flex-shrink-0 w-2 h-2 rounded-full ${disc.lu ? 'bg-gray-400' : 'bg-green-500'} inline-block absolute right-2 top-1/2 -translate-y-1/2"></span>
    `;

    div.onclick = () => {
      disc.lu = true;
      afficherChat(disc.nom, disc.avatar);
      afficherDiscussions();
    };

    contactsList.appendChild(div);
  });
}
function saveBrouillonsToStorage() {
  localStorage.setItem('brouillons', JSON.stringify(brouillons));
}

function loadBrouillonsFromStorage() {
  const data = localStorage.getItem('brouillons');
  if (data) {
    Object.assign(brouillons, JSON.parse(data));
  }
}
window.addEventListener('DOMContentLoaded', loadBrouillonsFromStorage);
window.addEventListener('beforeunload', saveBrouillonsToStorage);
    </script>
  </body>
</html>